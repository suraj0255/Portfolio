@page "/contactMe"
@rendermode InteractiveServer
@using System.Net.Mail
@using System.Net
@using System.Net.Sockets
@using DnsClient
@inject IConfiguration Configuration

<div class="contact-section">
    <h2 class="contact-title">📩 Get in Touch</h2>

    <!-- Contact Form -->
    <form class="contact-form" @onsubmit="HandleSubmit">
        <div class="form-group">
            <input type="text" id="name" required @bind="name" placeholder=" " />
            <label for="name">Your Name</label>
        </div>
        <div class="form-group">
            <input type="email" id="email" required @bind="email" placeholder=" " />
            <label for="email">Your Email</label>
        </div>
        <div class="form-group">
            <textarea id="message" rows="4" required @bind="message" placeholder=" "></textarea>
            <label for="message">Your Message</label>
        </div>

        <!-- Google reCAPTCHA -->
        <div class="captcha-wrapper">
            <div class="g-recaptcha" data-sitekey="@Configuration["GoogleReCAPTCHA:SiteKey"]"></div>
        </div>

        <button type="submit">Send Message</button>
    </form>

    @if (emailSent)
    {
        <p class="confirmation">✅ Thank you for contacting me! I’ll get back to you soon.</p>
    }
    else if (errorMessage != null)
    {
        <p class="error">@errorMessage</p>
    }

    <!-- Social Links -->
    <div class="social-links">
        <a href="https://linkedin.com/in/YOUR-LINKEDIN" target="_blank"><i class="fab fa-linkedin"></i></a>
        <a href="https://github.com/YOUR-GITHUB" target="_blank"><i class="fab fa-github"></i></a>
        <a href="mailto:YOUR@EMAIL.COM"><i class="fas fa-envelope"></i></a>
    </div>
</div>

<style>
    .contact-section {
        width: 100%;
        min-height: 90vh;
        padding: 4rem 1rem;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(20px);
        border-radius: 1.5rem;
        box-shadow: 0 6px 24px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
    }

    .contact-title {
        font-size: 2.4rem;
        font-weight: 700;
        color: #ffbe55;
        font-family: 'Poppins', sans-serif;
        text-align: center;
    }

    .contact-form {
        width: 100%;
        max-width: 520px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 1.2rem;
        padding: 2rem;
        backdrop-filter: blur(14px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-group {
        position: relative;
    }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 1rem;
            border: 1.5px solid rgba(31, 60, 136, 0.25);
            border-radius: 0.85rem;
            background: rgba(255, 255, 255, 0.55);
            font-size: 1rem;
            color: #1f3c88;
            outline: none;
        }

            .form-group input:focus,
            .form-group textarea:focus {
                border-color: #1f3c88;
                background: rgba(255, 255, 255, 0.95);
                box-shadow: 0 0 0 3px rgba(48, 122, 255, 0.15);
            }

        .form-group label {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.95rem;
            color: rgba(31, 60, 136, 0.65);
            pointer-events: none;
            transition: 0.3s ease;
        }

        .form-group input:focus + label,
        .form-group input:not(:placeholder-shown) + label,
        .form-group textarea:focus + label,
        .form-group textarea:not(:placeholder-shown) + label {
            top: -8px;
            left: 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
            background: #fff;
            padding: 0 0.3rem;
            border-radius: 0.3rem;
            color: #1f3c88;
        }

    .contact-form button {
        padding: 0.9rem;
        border: none;
        border-radius: 1rem;
        background: linear-gradient(135deg, #ffbe55, #2ecc71);
        color: #000;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s;
    }

        .contact-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.3);
        }

    .confirmation {
        color: #2ecc71;
        font-weight: 600;
    }

    .error {
        color: red;
        font-weight: 600;
    }

    .social-links {
        display: flex;
        gap: 1.5rem;
        font-size: 1.8rem;
        margin-top: 1rem;
    }

        .social-links a {
            color: #ffbe55;
            transition: color 0.3s;
        }

            .social-links a:hover {
                color: #2ecc71;
            }
</style>

@code {
    private string name = string.Empty;
    private string email = string.Empty;
    private string message = string.Empty;
    private bool emailSent = false;
    private string? errorMessage = null;

    private async Task HandleSubmit()
    {
        errorMessage = null;

        if (!await IsValidEmailAsync(email))
        {
            errorMessage = "❌ Please enter a valid email address that actually exists.";
            return;
        }

        // TODO: Validate Google reCAPTCHA response here before sending email

        var smtpServer = Configuration["EmailSettings:SmtpServer"];
        var port = int.Parse(Configuration["EmailSettings:Port"]);
        var username = Configuration["EmailSettings:Username"];
        var password = Configuration["EmailSettings:Password"];
        var fromEmail = Configuration["EmailSettings:FromEmail"];
        var toEmail = Configuration["EmailSettings:ToEmail"];

        await SendEmail(smtpServer, port, username, password, fromEmail, toEmail, name, email, message);

        name = string.Empty;
        email = string.Empty;
        message = string.Empty;
        emailSent = true;
    }

    private async Task<bool> IsValidEmailAsync(string email)
    {
        try
        {
            var mailAddr = new MailAddress(email);
            var domain = mailAddr.Host;

            var lookup = new LookupClient();
            var result = await lookup.QueryAsync(domain, QueryType.MX);

            return result.Answers.MxRecords().Any();
        }
        catch
        {
            return false;
        }
    }

    private async Task SendEmail(string smtpServer, int port, string username, string password, string fromEmail, string toEmail, string name, string email, string message)
    {
        using var smtpClient = new SmtpClient(smtpServer)
            {
                Port = port,
                Credentials = new NetworkCredential(username, password),
                EnableSsl = true,
            };

        var mailMessage = new MailMessage
            {
                From = new MailAddress(fromEmail),
                Subject = $"New Message from {name} ({email})",
                Body = $"Name: {name}\nEmail: {email}\nMessage: {message}",
                IsBodyHtml = false,
            };

        mailMessage.To.Add(toEmail);

        try
        {
            await smtpClient.SendMailAsync(mailMessage);
            Console.WriteLine("Email sent successfully!");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to send email: {ex.Message}";
        }
    }
}
